# 因子分解机(Factorization Machine, FM)

* 核心思想: 二阶特征组合

## 特征组合模型的进化角度

* 线性模型 LR
    $$ \hat{y} = w_0 + \sum_{i=1}^n{w_i x_i} $$
    * 优点:简单、效率高
    * 缺点:难以捕获组合特征（需要人工特征组合，费时费力）

* 线性模型的改进: 直接在计算公式里加入二阶特征组合（类似多项式核SVM）
    $$ \hat{y} = w_0 + \sum_{i=1}^n{w_i x_i} + \sum_{i=1}^n\sum_{j=i+1}^n{w_{i,j}x_i x_j} $$
    * $x_i x_j$理解为两种特征组合出来的特征，同时拥有这两种特征的样本可能很少，所以存在$w_{i,j}=0$的情况
    * 优点:直接将特征两两组合引入模型
    * 缺点:组合特征的泛化能力弱（当组合特征$x_i x_j = 0$时,$w_{i,j} = 0$）,不适用于大规模稀疏特征

* FM: 对每个特征学习一个`k维的稠密向量`,组合特征$x_i x_j$的权值用特征对应特征向量的内积表示
    $$ \hat{y} = w_0 + \sum_{i=1}^n{w_i x_i} + \sum_{i=1}^n\sum_{j=i+1}^n{<v_i, v_j>x_i x_j} $$
    * 本质:做特征的embedding
    * `不要混淆`: $v_i, v_j$是特征i和特征j的Embedding,Embedding的大小是k维的, $x_i, x_j$是一个样本的第i个特征取值和第j个特征取值
    * 和DNN排序模型的区别:只是少了MLP，直接对多阶特征非线性组合建模
    * FM模型`泛化能力强`的根本原因:学习了特征的Embedding，即计算了特征之间的相关性作为两两特征组合的权值，即使没有包含这样组合特征的样本，也能通过内积算出这个新特征组合的权重

## 协同过滤模型（MF, Matrix Factorization, 矩阵分解）的进化角度

* 核心思想:是通过两个低维小矩阵的乘积计算（用户embedding，物品embedding）大的评分稀疏矩阵
* 本质:Embedding了用户和物品协同信息的降维模型
* `MF和FM的关系`
    * MF模型是FM模型的特例，MF可以被认为是只有User ID 和Item ID这两个特征Fields的FM模型
    * FM则是MF模型的进一步拓展，除了User ID和Item ID这两类特征外，很多其它类型的特征都可以转化为embedding低维向量表达，并计算任意两个特征embedding的内积，即特征组合的权重
    * FM融入了更多特征及Side information embedding化融，所以更灵活，能适应更多的场合
    * MF不支持更多特征的便捷引入,受限严重,很难真正实用,因而不用于Ranking阶段，通常作为一路召回的形式存在

## FM的实现, 提升计算效率

* 公式上，FM的二阶特征组合意味着任意两个特征都要进行交叉组合，时间复杂度是$n^2$, `但n往往是个非常巨大的特征数`
* `上线算法基本上都选择速度快的`，FFM模型作为排序模型，效果优于FM模型，但FFM模型对参数存储量要求太多，以及无法做到FM的运行效率，严重阻碍FFM模型大规模数据场景实用化；DNN排序模型也一样，超大规模训练或者在线Serving速度根本跟不上
* 公式改写时间复杂度:$O(k n^2) \rightarrow O(k n)$, 其中k是特征Embedding大小，n是特征数；真实的推荐数据的特征值极为稀疏，大量xi取值是0，意味着真正需要计算的特征数是远远小于总特征数目n，进一步加快FM的运算效率
$$
\begin{aligned}
&\sum_{i=1}^n\sum_{j=i+1}^n{<v_i, v_j>x_i x_j} \\
&= \frac{1}{2}\sum_{i=1}^n\sum_{j=1}^n{<v_i, v_j>x_i x_j} - \frac{1}{2}\sum_{i=1}^n{<v_i, v_i>x_i x_i} \\
&= \frac{1}{2}(\sum_{i=1}^n\sum_{j=1}^n\sum_{f=1}^k{v_{i,f} v_{j,f} x_i x_j} - \sum_{i=1}^n\sum_{f=1}^k{v_{i,f} v_{i,f} x_i x_i}) \\
&= \frac{1}{2}\sum_{f=1}^k((\sum_{i=1}^n{v_{i,f} x_i}) (\sum_{j=1}^n{ v_{j,f} x_j}) - \sum_{i=1}^n{v_{i,f}^2 x_i^2}) \\
&= \frac{1}{2}\sum_{f=1}^k((\sum_{i=1}^n{v_{i,f} x_i})^2 - \sum_{i=1}^n{v_{i,f}^2 x_i^2}) \\
\end{aligned}
$$
* 对改写后平方项的理解:`等价于将FM的所有特征的embedding向量累加的到向量V`($\sum_{i=1}^n$)，`之后求V的内积`($\sum_{f=1}^k v_f^2 = V^T V$)

## FM统一多路召回的基本思想

#### 统一召回和多路召回的比较
* 多路召回
    * 各路的召回得分不可比较，因而需要第二阶段Ranking来同一分数
    * 每一路召回多少候选项超参K难以选择
    * 在召回和排序之间可能存在信息鸿沟的问题，排序阶段以特征为表达方式，召回则以“路、策略、具体模型”为表达方式,可能新增的召回通道在排序模型上根本无法体现
    * 新上线召回方式比较灵活，对已线上的召回系统影响很小，因为不同路召回之间没有耦合关系
* 统一召回
    * FM召回阶段的得分，无论item来自哪路召回，都是可以比较的
    * 每路召回候选项超参K可以由FM模型调整成个性化
    * 采用FM模型来做召回的话，新增一路召回就转化为新增特征的问题，而这一点和Ranking阶段在表现形式上是相同的，对于召回和排序两个阶段来说，两者都转化成了新增特征问题，所以两个阶段的存在信息鸿沟的概率小
    * 新增召回方式时表现为新增一种或者几种特征，可能需要完全重新训练一个新的FM模型，整个召回系统重新部署上线，灵活性比多路召回要差

* `如何用FM模型做召回? 如何把多路召回改造成单路召回?这是两个不同的问题`

#### 用FM做召回模型

* Step 1 离线训练:线上收集到的用户ctr数据来作为训练数据，线下训练一个完整的FM模型;每个特征和这个特征对应的训练好的embedding向量存好待用
* Step 2 特征分为三个子集合:用户相关特征集合(User)、物品相关特征集合(Item)、上下文相关的特征集合(Context)
* 极简版FM（不考虑Context特征）
    * 设有n个User特征，m个Item特征
    * $ U = \sum_{i=1}^n {U_i}, I = \sum_{j=1}^m {I_j} $; U向量是该用户n个k维特征Embedding的加和（针对一个用户，因为还要和$ x_i $相乘）; I向量是该物品m个k维特征Embedding的加和（针对一个Item，因为还要和 $ x_j $相乘），`计算公式的第一个平方项的第一步`
    * U 向量离线计算，存入Redis中，key为UserID; I 向量离线计算，存入Faiss中
    * 召回过程： UserID $ \rightarrow $ U $ \rightarrow $ faiss $ \rightarrow $ Top k Item `计算公式的第一个平方项的第二步`
    * `相当于在用户特征和物品特征之间做两两特征组合，只是少了U内部之间特征，及I内部特征之间的特征组合`，一般而言，其实不需要做U内部特征之间以及I内部特征之间的特征组合，因为对最终效果影响很小
* 加入Context特征
    * 用户发生行为的场景上下文特征，比如：什么时间，在什么地方，用的什么设备在刷新
    * Context特征的特点`动态性强`:近乎实时变化，`无法离线计算`，比如刷新微博的时间,美团嘀嘀则对地理位置特别敏感
    * 场景上下文特征数都不多，在线计算在速度方面应可接受：$ U = \sum_{k=1}^K {C_k} $
    * 召回过程:$score1 = <U, C> \rightarrow (U + C)$ Faiss找到Top k的到每个物品的score2, $\rightarrow score1 + score2$; score1的加入虽然不影响物品的排序，但可能会影响FM外的Sigmoid得到的最终得分（`考虑了U/I/C两两之间的特征组合`）

#### 用FM统一多路召回

* 多路召回下的每一路召回策略，绝大多数情况下，可以在FM召回模型模式中转化为新增特征的方式
    * Tag，Topic，Entity，热门，相同地域直接作为特征加入User或Item特征集合中；由于FM本身就是协同过滤的扩展，因而协同过滤特征被直接包含



## 参考
[1] 原论文[Rendle, Factorization Machines, 2010](https://www.csie.ntu.edu.tw/~b97053/paper/Rendle2010FM.pdf)
[2] 知乎: [推荐系统召回四模型之：全能的FM模型](https://zhuanlan.zhihu.com/p/58160982)